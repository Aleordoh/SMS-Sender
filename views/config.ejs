<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/main.css">
  <style>
    select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1><%= title %></h1>
    <h2>Synway SMG4008-8WA Gateway</h2>

    <div class="nav">
      <a href="/sms">üì§ Enviar SMS</a>
      <a href="/sms/inbox">üì® Mensajes Recibidos</a>
      <a href="/sms/config">‚öôÔ∏è Configuraci√≥n</a>
    </div>

    <div class="info-box">
      <h3>üì° Configuraci√≥n Actual</h3>
      <div class="config-item">
        <span class="config-label">Host/IP:</span>
        <span class="config-value"><%= config.host %></span>
      </div>
      <div class="config-item">
        <span class="config-label">Protocolo:</span>
        <span class="config-value"><%= config.protocol %></span>
      </div>
      <div class="config-item">
        <span class="config-label">Puerto:</span>
        <span class="config-value"><%= config.port %></span>
      </div>
      <div class="config-item">
        <span class="config-label">Usuario:</span>
        <span class="config-value"><%= config.username %></span>
      </div>
      <div class="config-item">
        <span class="config-label">Delay entre env√≠os:</span>
        <span class="config-value"><%= config.sms_delay || 6000 %> ms</span>
      </div>
    </div>

    <div class="api-docs">
      <h3>üìñ Documentaci√≥n del API Synway</h3>
      <p>El gateway Synway SMG4008-8WA utiliza una API HTTP para enviar SMS.</p>
      <p><strong>Endpoint:</strong> <code>http://[host]:80/API/TaskHandle</code></p>
      <p><strong>Par√°metros del JSON:</strong></p>
      <ul style="margin-left: 20px; margin-top: 10px;">
        <li><code>event</code>: "txsms" para env√≠o de SMS</li>
        <li><code>userid</code>: ID de usuario para tracking</li>
        <li><code>num</code>: N√∫mero de tel√©fono destino</li>
        <li><code>port</code>: Puerto a usar (-1 para auto)</li>
        <li><code>encoding</code>: 0 para ASCII, 8 para Unicode</li>
        <li><code>smsinfo</code>: Contenido del mensaje</li>
      </ul>
      <p style="margin-top: 10px;"><strong>Manuales:</strong>
        <a href="/manual/SMG_Wireless_Gateway_APIv1.8.0.pdf" target="_blank" style="color: #667eea;">API v1.8.0</a> |
        <a href="/manual/Gateway%20Synway%20GSM%20Series%20SMG4xxx_Manual.pdf" target="_blank" style="color: #667eea;">Manual del Gateway</a>
      </p>
      <p style="margin-top: 10px; color:#c62828"><strong>Importante:</strong> En el gateway, en <em>System Param ‚Üí API Parameters</em>, activa <strong>API Enabled = Yes</strong>. Sin eso, el env√≠o puede fallar aun cuando la conexi√≥n sea exitosa.</p>
    </div>

    <div class="test-section">
      <div class="test-form">
        <h3 style="margin-bottom: 15px; color: #667eea;">üîç Probar Conexi√≥n</h3>
        <form id="testForm">
          <div class="form-group">
            <label for="test_host">Host/IP:</label>
            <input type="text" id="test_host" name="gateway_host" value="<%= config.host %>" required>
          </div>
          <div class="form-group">
            <label for="test_protocol">Protocolo:</label>
            <select id="test_protocol" name="gateway_protocol" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:5px;">
              <option value="http" <%= config.protocol === 'http' ? 'selected' : '' %>>http</option>
              <option value="https" <%= config.protocol === 'https' ? 'selected' : '' %>>https</option>
            </select>
          </div>
          <div class="form-group">
            <label for="test_port">Puerto:</label>
            <input type="number" id="test_port" name="gateway_port" value="<%= config.port %>" required>
          </div>
          <div class="form-group">
            <label for="test_username">Usuario:</label>
            <input type="text" id="test_username" name="gateway_username" value="<%= config.username %>" required>
          </div>
          <div class="form-group">
            <label for="test_password">Contrase√±a:</label>
            <input type="password" id="test_password" name="gateway_password" value="<%= config.password %>" required>
          </div>
          <div class="form-group">
            <label for="test_delay">‚è±Ô∏è Delay entre env√≠os (ms):</label>
            <input type="number" id="test_delay" name="sms_delay" value="<%= config.sms_delay || 6000 %>" min="0" max="10000" required>
            <small style="color: #666; display: block; margin-top: 5px;">Tiempo de espera entre cada SMS (0-10000ms). Recomendado: 6000ms (6 segundos)</small>
          </div>
          <button type="submit">Probar Conexi√≥n</button>
        </form>
        <div id="testResult"></div>
      </div>
    </div>

    <footer>
      <p>SMS Sender - Synway SMG4008-8WA Gateway</p>
    </footer>
  </div>

  <script>
    document.getElementById('testForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const resultDiv = document.getElementById('testResult');
      resultDiv.style.display = 'block';
      resultDiv.className = '';
      resultDiv.textContent = 'Probando conexi√≥n...';

      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await fetch('/sms/test-connection', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          resultDiv.className = 'success';
          resultDiv.textContent = '‚úì ' + result.message;
        } else {
          resultDiv.className = 'error';
          resultDiv.textContent = '‚úó ' + result.message;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.textContent = '‚úó Error al probar la conexi√≥n: ' + error.message;
      }
    });
  </script>
</body>

</html>