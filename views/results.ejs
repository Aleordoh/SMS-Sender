<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/results.css">
  <link rel="stylesheet" href="/css/inbox.css">
</head>
</head>

<body>
  <div class="container wide">
    <h1><%= title %></h1>

    <div class="nav">
      <a href="/sms">üì§ Enviar SMS</a>
      <a href="/sms/inbox">üì® Mensajes Recibidos</a>
      <a href="/sms/config">‚öôÔ∏è Configuraci√≥n</a>     
    </div>

    <div class="summary">
      <div class="summary-card total">
        <h3>Total</h3>
        <div class="number"><%= total %></div>
      </div>
      <div class="summary-card success">
        <h3>Exitosos</h3>
        <div class="number"><%= totalSent %></div>
      </div>
      <div class="summary-card failed">
        <h3>Fallidos</h3>
        <div class="number"><%= totalFailed %></div>
      </div>
    </div>

    <table class="results-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Tel√©fono</th>
          <th>Mensaje</th>
          <th>Puerto</th>
          <th>Estado</th>
          <th>Detalles</th>
        </tr>
      </thead>
      <tbody>
        <% results.forEach((result, index) => { %>
        <tr>
          <td><%= index + 1 %></td>
          <td><%= result.phone %></td>
          <td class="message-preview" title="<%= result.message %>">
            <%= result.message %>
          </td>
          <td>
            <% if (result.port) { %>
            <span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px;">Puerto <%= result.port %></span>
            <% } else { %>
            <span style="color: #999;">-</span>
            <% } %>
          </td>
          <td>
            <span class="status <%= result.success ? 'success' : 'failed' %>">
              <%= result.success ? '‚úì Enviado' : '‚úó Fallido' %>
            </span>
          </td>
          <td>
            <% if (result.error) { %>
            <small style="color: #f44336;"><%= result.error %></small>
            <% } else { %>
            <small style="color: #4caf50;">OK</small>
            <% } %>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>

    <div class="button-group">
      <a href="/sms" class="button">üì§ Enviar M√°s SMS</a>
    </div>

    <!-- Responses Section -->
    <div class="responses-section">
      <h2>üì® Consultar Respuestas SMS</h2>
      <div class="info-box">
        <p>Consulta los SMS recibidos en el gateway para ver si hay respuestas a los mensajes enviados.</p>
      </div>

      <div class="test-form" style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
        <form id="queryResponsesForm">
          <div class="form-group">
            <label for="begintime">Desde (√∫ltimas horas):</label>
            <select id="timeRange" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px;">
              <option value="1">√öltima hora</option>
              <option value="3">√öltimas 3 horas</option>
              <option value="6" selected>√öltimas 6 horas</option>
              <option value="12">√öltimas 12 horas</option>
              <option value="24">√öltimas 24 horas</option>
            </select>
          </div>
          <button type="submit">üîç Consultar Respuestas</button>
        </form>
      </div>

      <div id="responsesResult" style="display: none;">
        <div id="responsesContent"></div>
        <div id="downloadButton" style="display: none; margin-top: 15px;">
          <button onclick="downloadResponses()" class="button" style="width: 100%;">üì• Descargar Respuestas (CSV)
          </button>
        </div>
      </div>
    </div>

    <footer>
      <p>SMS Sender - Synway SMG4008-8WA Gateway</p>
    </footer>
  </div>

  <script>
    let lastQueryParams = null;

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      // Format: YYYYMMDDHHmmss -> readable format
      const year = dateStr.substr(0, 4);
      const month = dateStr.substr(4, 2);
      const day = dateStr.substr(6, 2);
      const hour = dateStr.substr(8, 2);
      const min = dateStr.substr(10, 2);
      const sec = dateStr.substr(12, 2);
      return `${day}/${month}/${year} ${hour}:${min}:${sec}`;
    }

    function getTimeRange(hours) {
      const now = new Date();
      const past = new Date(now.getTime() - hours * 60 * 60 * 1000);

      function formatTime(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        const sec = String(date.getSeconds()).padStart(2, '0');
        return `${year}${month}${day}${hour}${min}${sec}`;
      }

      return {
        begintime: formatTime(past),
        endtime: formatTime(now)
      };
    }

    document.getElementById('queryResponsesForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const hours = parseInt(document.getElementById('timeRange').value);
      const timeRange = getTimeRange(hours);
      // Don't include port parameter - let API query all ports
      lastQueryParams = {
        ...timeRange
      };

      const resultDiv = document.getElementById('responsesResult');
      const contentDiv = document.getElementById('responsesContent');
      const downloadBtn = document.getElementById('downloadButton');

      resultDiv.style.display = 'block';
      contentDiv.innerHTML = '<p style="text-align: center; padding: 20px;">Consultando respuestas...</p>';
      downloadBtn.style.display = 'none';

      try {
        const response = await fetch('/sms/query-received', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(lastQueryParams)
        });

        const result = await response.json();

        if (result.success && result.messages && result.messages.length > 0) {
          let html = '<table class="responses-table">';
          html += '<thead><tr><th>#</th><th>Tel√©fono</th><th>Mensaje</th><th>Fecha/Hora</th><th>Puerto</th></tr></thead>';
          html += '<tbody>';

          result.messages.forEach((msg, index) => {
            html += `<tr>
                            <td>${index + 1}</td>
                            <td>${msg.phone || 'N/A'}</td>
                            <td>${msg.message || 'N/A'}</td>
                            <td>${formatDateTime(msg.time)}</td>
                            <td>${msg.port || 'N/A'}</td>
                        </tr>`;
          });

          html += '</tbody></table>';
          html +=
            `<p style="text-align: center; color: #28a745; margin-top: 10px;">‚úì Se encontraron ${result.messages.length} mensajes recibidos</p>`;
          contentDiv.innerHTML = html;
          downloadBtn.style.display = 'block';
        } else {
          contentDiv.innerHTML =
            '<div class="no-responses"><p>üì≠ No se encontraron respuestas en el per√≠odo seleccionado</p></div>';
          downloadBtn.style.display = 'none';
        }
      } catch (error) {
        contentDiv.innerHTML =
          `<div class="alert alert-error">‚úó Error al consultar respuestas: ${error.message}</div>`;
        downloadBtn.style.display = 'none';
      }
    });

    function downloadResponses() {
      if (!lastQueryParams) return;

      const params = new URLSearchParams(lastQueryParams);
      window.location.href = `/sms/download-received?${params.toString()}`;
    }
  </script>
</body>

</html>